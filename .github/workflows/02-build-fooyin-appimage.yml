# .github/workflows/02-build-fooyin-appimage.yml
name: 02. Build Fooyin AppImage

on:
  workflow_dispatch:
    inputs:
      fooyin_ref:
        description: 'Fooyin Git ref (tag/branch/commit, e.g., v0.9.1 or master)'
        required: true
        default: 'master'
  workflow_call:
    inputs:
      fooyin_ref:
        description: 'Fooyin Git ref (tag/branch/commit, e.g., v0.9.1 or master)'
        type: string
        required: true
  push:
    branches:
      - main # Ð˜Ð»Ð¸ Ð²Ð°ÑˆÐ° Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð²ÐµÑ‚ÐºÐ°
  pull_request:
    branches:
      - main

# ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸Ð¸ ÐºÐ°Ðº Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð²ÐµÑ€Ñ…Ð½ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² env
env:
  # Ð’ÐµÑ€ÑÐ¸Ð¸ (Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ 01-prepare-and-cache-env.yml)
  QT_VERSION: "6.8.0"
  FFMPEG_VERSION: "7.1.2"
  # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
  INSTALL_PREFIX: ${{ github.workspace }}/AppDir
  FOYIN_SOURCE_DIR: ${{ github.workspace }}/fooyin
  # ÐšÐ»ÑŽÑ‡ ÐºÑÑˆÐ° (Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ 01-prepare-and-cache-env.yml)
  CACHE_KEY: "build-env-qt6.8.0-ffmpeg7.1.2-v3"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:
      - name: Checkout this repo (for recipe.yml)
        uses: actions/checkout@v4

      - name: Determine Fooyin ref
        id: determine-ref
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            REF="${{ github.event.inputs.fooyin_ref }}"
          elif [[ "${{ github.event_name }}" == "workflow_call" ]]; then
            REF="${{ github.event.inputs.fooyin_ref }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            REF="master"
          else 
            REF="master"
          fi
          echo " "
          echo "REF=$REF" >> $GITHUB_ENV
          echo "REF=$REF"
          echo " "
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "ref=$REF"

      - name: Checkout Fooyin source
        uses: actions/checkout@v4
        with:
          repository: fooyin/fooyin
          ref: ${{ env.REF }}
          path: ${{ env.FOYIN_SOURCE_DIR }}

      - name: Setup AppDir structure
        run: |
          mkdir -p ${{ env.INSTALL_PREFIX }}
          mkdir -p ${{ env.INSTALL_PREFIX }}/share/applications
          mkdir -p ${{ env.INSTALL_PREFIX }}/share/icons/hicolor/256x256/apps
        

      # --- Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐšÐ­Ð¨Ð Ð¡Ð Ð•Ð”Ð« ---
      - name: Restore cached build environment
        uses: actions/cache/restore@v4
        id: restore-env
        with:
          path: ${{ env.INSTALL_PREFIX }}
          key: ${{ env.CACHE_KEY }}
          fail-on-cache-miss: true # ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾: ÐµÑÐ»Ð¸ ÐºÑÑˆ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ÑÑ

      - name: Verify restored environment
        run: |
          if [ -f "${{ env.INSTALL_PREFIX }}/bin/qmake" ]; then
            echo "Qt qmake found."
            ${{ env.INSTALL_PREFIX }}/bin/qmake -v
          else
            echo "Warning: qmake not found in cache."
          fi
          if [ -f "${{ env.INSTALL_PREFIX }}/lib/libavcodec.so" ]; then
            echo "FFmpeg libraries found."
          else
            echo "Warning: FFmpeg libraries not found in cache."
          fi

      - name: Debug Qt Cache Structure and Files
        run: |
          echo "=====[ DEBUG: Qt Cache Structure ]====="
          
          echo "--- Qt Installation Prefix ---"
          echo "INSTALL_PREFIX: ${{ env.INSTALL_PREFIX }}"
          
          echo "--- Checking if INSTALL_PREFIX exists ---"
          if [ -d "${{ env.INSTALL_PREFIX }}" ]; then
            echo "Directory exists."
          else
            echo "ERROR: INSTALL_PREFIX directory does NOT exist!"
          fi
          
          echo "--- Listing contents of INSTALL_PREFIX (top level) ---"
          ls -la "${{ env.INSTALL_PREFIX }}" | head -n 20
          
          echo "--- Checking bin directory ---"
          if [ -d "${{ env.INSTALL_PREFIX }}/bin" ]; then
            echo "bin/ exists. Contents (first 10):"
            ls -la "${{ env.INSTALL_PREFIX }}/bin" | head -n 10
            echo "qmake exists?"
            ls -la "${{ env.INSTALL_PREFIX }}/bin/qmake" 2>/dev/null || echo "qmake NOT in bin/"
          else
            echo "bin/ directory does NOT exist!"
          fi
          
          echo "--- Checking lib directory ---"
          if [ -d "${{ env.INSTALL_PREFIX }}/lib" ]; then
            echo "lib/ exists. Size: $(du -sh ${{ env.INSTALL_PREFIX }}/lib | cut -f1)"
            echo "Number of .so files: $(find ${{ env.INSTALL_PREFIX }}/lib -name '*.so*' 2>/dev/null | wc -l)"
            echo "Looking for Widgets library..."
            find ${{ env.INSTALL_PREFIX }}/lib -name "*Widget*" -type f 2>/dev/null || echo "No Widget .so files found directly in lib/"
          else
            echo "lib/ directory does NOT exist!"
          fi
          
          echo "--- Checking lib/cmake directory ---"
          if [ -d "${{ env.INSTALL_PREFIX }}/lib/cmake" ]; then
            echo "lib/cmake/ exists. Contents:"
            ls -la "${{ env.INSTALL_PREFIX }}/lib/cmake/" | head -n 15
          else
            echo "lib/cmake/ directory does NOT exist!"
          fi
          
          echo "--- Detailed Qt6Widgets Check ---"
          WIDGETS_CMAKE_DIR="${{ env.INSTALL_PREFIX }}/lib/cmake/Qt6Widgets"
          if [ -d "$WIDGETS_CMAKE_DIR" ]; then
            echo "Qt6Widgets cmake directory EXISTS: $WIDGETS_CMAKE_DIR"
            echo "Contents of Qt6Widgets cmake dir:"
            ls -la "$WIDGETS_CMAKE_DIR"
            
            echo "Checking for specific files:"
            declare -a files_to_check=("Qt6WidgetsConfig.cmake" "Qt6WidgetsDependencies.cmake")
            for file in "${files_to_check[@]}"; do
              if [ -f "$WIDGETS_CMAKE_DIR/$file" ]; then
                echo "  [FOUND] $file"
                # Show first few lines of the config file to see what it tries to include
                if [[ "$file" == *"Config.cmake" ]]; then
                  echo "    First 5 lines:"
                  head -n 5 "$WIDGETS_CMAKE_DIR/$file" | sed 's/^/      /'
                fi
              else
                echo "  [MISSING] $file"
              fi
            done
          else
            echo "Qt6Widgets cmake directory DOES NOT EXIST: $WIDGETS_CMAKE_DIR"
            echo "Searching for any Qt6Widgets* dirs in cmake..."
            find ${{ env.INSTALL_PREFIX }}/lib/cmake/ -name "Qt6Widgets*" -type d 2>/dev/null || echo "No Qt6Widgets directories found in cmake/"
          fi
          
          echo "--- Full Search for Qt6WidgetsDependencies.cmake ---"
          echo "Searching entire cache prefix for Qt6WidgetsDependencies.cmake:"
          find ${{ env.INSTALL_PREFIX }} -name "Qt6WidgetsDependencies.cmake" 2>/dev/null || echo "Qt6WidgetsDependencies.cmake NOT FOUND anywhere in cache"
          
          echo "=====[ END DEBUG ]====="


      # --- Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐÐ«Ð¥ Ð—ÐÐ’Ð˜Ð¡Ð˜ÐœÐžÐ¡Ð¢Ð•Ð™ Ð”Ð›Ð¯ Ð¡Ð‘ÐžÐ ÐšÐ˜ FOYIN ---
      - name: Install system dependencies for Fooyin build
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils coreutils desktop-file-utils \
            fakeroot fuse libgdk-pixbuf2.0-dev \
            patchelf python3-pip python3-setuptools \
            squashfs-tools strace util-linux zsync \
            libgl1-mesa-dev libglu1-mesa-dev \
            mesa-common-dev freeglut3-dev \
            build-essential cmake git pkg-config \
            libxkbcommon-dev libvulkan-dev \
            libgme-dev libarchive-dev \
            libopenmpt-dev libpipewire-0.3-dev \
            libsdl2-dev libsndfile1-dev \
            libebur128-dev ccache libxcb-cursor0
          pip3 install --upgrade pip
          #sudo pip3 install appimage-builder
          pip3 index versions appimage-builder
          #pip3 install appimage-builder==0.8.2
          pip3 install appimage-builder==1.1.0
          pip3 install packaging==21.3
          #appimage-builder --version
          python3.10 -m appimagebuilder --version
            
      # --- Ð’ÐžÐ¡Ð¡Ð¢ÐÐÐžÐ’Ð›Ð•ÐÐ˜Ð• ÐšÐ­Ð¨Ð CCACHE ---
      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/ccache
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡, Ð·Ð°Ð²Ð¸ÑÑÑ‰Ð¸Ð¹ Ð¾Ñ‚ Ñ…ÑÑˆÐ° workflow Ñ„Ð°Ð¹Ð»Ð° Ð¸ Ð²ÐµÑ€ÑÐ¸Ð¹ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²
          # Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚, Ñ‡Ñ‚Ð¾ ÐºÑÑˆ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ±Ñ€Ð¾ÑˆÐµÐ½ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ workflow Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ð¾Ð²
          key: ccache-${{ runner.os }}-${{ env.QT_VERSION }}-${{ env.FFMPEG_VERSION }}
          # restore-keys Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÑŽÑ‚ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ñ‹Ð¹ ÐºÑÑˆ, ÐµÑÐ»Ð¸ Ñ‚Ð¾Ñ‡Ð½Ð¾Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾
          restore-keys: |
            ccache-${{ runner.os }}-${{ env.QT_VERSION }}-
            ccache-${{ runner.os }}-

      - name: Delete ccache cache
        uses: actions/github-script@v7
        with:
          script: |
            const cacheKey = 'ccache-${{ runner.os }}-${{ env.QT_VERSION }}-${{ env.FFMPEG_VERSION }}';
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`ðŸ” Searching for ccache with key: ${cacheKey}`);

            try {
              const response = await github.rest.actions.getActionsCacheList({
                owner,
                repo,
                per_page: 100
              });

              const caches = response.data.actions_caches;
              console.log(`ðŸ“¦ Found ${caches.length} cache entries total`);

              const targetCache = caches.find(cache => cache.key === cacheKey);

              if (targetCache) {
                const cacheId = targetCache.id;
                console.log(`ðŸ—‘ï¸ Found ccache to delete. ID: ${cacheId}, Key: ${targetCache.key}, Size: ${targetCache.size} bytes`);
                
                await github.rest.actions.deleteActionsCacheById({
                  owner,
                  repo,
                  cache_id: cacheId
                });
                console.log(`âœ… Successfully deleted ccache ID ${cacheId}`);
              } else {
                console.log(`â„¹ï¸ ccache with key '${cacheKey}' not found.`);
              }
            } catch (error) {
              console.error(`âŒ Failed to delete ccache: ${error.message}`);
            }
      
      - name: Setup ccache
        run: |
          echo "Setting up ccache..."
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ ÐºÑÑˆÐ° ccache
          mkdir -p ${{ github.workspace }}/ccache
          
          # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ ccache Ñ‡ÐµÑ€ÐµÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          echo "CCACHE_DIR=${{ github.workspace }}/ccache" >> $GITHUB_ENV
          echo "CCACHE_BASEDIR=${{ github.workspace }}" >> $GITHUB_ENV
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð»Ð¸Ð¼Ð¸Ñ‚ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ€ ÐºÑÑˆÐ° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 2 Ð“Ð‘)
          echo "CCACHE_MAXSIZE=2G" >> $GITHUB_ENV
          # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐ¶Ð°Ñ‚Ð¸Ðµ ÐºÑÑˆÐ°
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          # (ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾) Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
          # echo "CCACHE_LOGFILE=${{ github.workspace }}/ccache.log" >> $GITHUB_ENV
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ (Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ð¾Ð¹)
          echo "Initial ccache stats:"
          ccache -s
          
          # ÐÐ• ÐÐ£Ð–ÐÐž ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ CC/CXX Ð·Ð´ÐµÑÑŒ Ð´Ð»Ñ CMake.
          # Ð’Ð¼ÐµÑÑ‚Ð¾ ÑÑ‚Ð¾Ð³Ð¾ Ð±ÑƒÐ´ÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ„Ð»Ð°Ð³Ð¸ CMAKE Ð¿Ñ€Ð¸ Ð²Ñ‹Ð·Ð¾Ð²Ðµ cmake.
          # echo "CC=ccache gcc" >> $GITHUB_ENV  # <-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
          # echo "CXX=ccache g++" >> $GITHUB_ENV # <-- Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
          
          echo "ccache setup complete."

      # --- Ð¡Ð‘ÐžÐ ÐšÐ FOOYIN ---
      - name: Build Fooyin
        run: |
          cd ${{ env.FOYIN_SOURCE_DIR }}
          #rm -rf build 
          mkdir -p build && cd build
          echo "Starting Fooyin build with ccache..."
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ccache Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹
          echo "ccache stats before config/build:"
          ccache -s
          
          # --- ÐšÐžÐÐ¤Ð˜Ð“Ð£Ð ÐÐ¦Ð˜Ð¯ CMAKE Ñ ccache launcher ---
          cmake .. \
            -DCMAKE_INSTALL_PREFIX=${{ env.INSTALL_PREFIX }} \
            -DCMAKE_PREFIX_PATH=${{ env.INSTALL_PREFIX }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          
          # --- Ð¡Ð‘ÐžÐ ÐšÐ ---
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Ñ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ñ‹Ð¼ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»Ð¸Ð·Ð¼Ð¾Ð¼, ÐºÐ°Ðº Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°Ð½ÐµÐµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ½Ð¸Ð·Ð¸Ñ‚ÑŒ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð½Ð° Ð¿Ð°Ð¼ÑÑ‚ÑŒ
          cmake --build . --parallel 1
          
          # --- Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ ---
          cmake --build . --parallel 1 --target install
          echo " "
          find $INSTALL_PREFIX -name fooyin -type f
          echo " "
          echo "Fooyin build/install completed."
          echo " "
          ls -la 
          echo " "
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ccache Ð¿Ð¾ÑÐ»Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸
          echo "ccache stats after build:"
          ccache -s

      # --- Ð¡ÐžÐ¥Ð ÐÐÐ•ÐÐ˜Ð• ÐšÐ­Ð¨Ð CCACHE ---
      - name: Save ccache
        # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ð²ÑÐµÐ³Ð´Ð°, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° ÑƒÐ¿Ð°Ð»Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/ccache
          key: ccache-${{ runner.os }}-${{ env.QT_VERSION }}-${{ env.FFMPEG_VERSION }}      
      
      # --- ÐŸÐžÐ”Ð“ÐžÐ¢ÐžÐ’ÐšÐ AppDir (Desktop Ñ„Ð°Ð¹Ð» Ð¸ Ð¸ÐºÐ¾Ð½ÐºÐ°) ---
      - name: Prepare AppDir (Desktop file and icon)
        run: |
          cp "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/org.fooyin.fooyin.png" "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/fooyin.png"
          cp "$INSTALL_PREFIX/share/applications/org.fooyin.fooyin.desktop" "$INSTALL_PREFIX/share/applications/fooyin.desktop"
          mkdir -p "$INSTALL_PREFIX/usr/share/icons/hicolor/256x256/apps/"
          mkdir -p "$INSTALL_PREFIX/usr/share/applications/"         
          cp "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/org.fooyin.fooyin.png" "$INSTALL_PREFIX/usr/share/icons/hicolor/256x256/apps/fooyin.png"
          cp "$INSTALL_PREFIX/share/applications/org.fooyin.fooyin.desktop" "$INSTALL_PREFIX/usr/share/applications/fooyin.desktop"
          cp "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/org.fooyin.fooyin.png" "$INSTALL_PREFIX/usr/share/icons/hicolor/256x256/apps/org.fooyin.fooyin.png"
          cp "$INSTALL_PREFIX/share/applications/org.fooyin.fooyin.desktop" "$INSTALL_PREFIX/usr/share/applications/org.fooyin.fooyin.desktop"
          echo "ÑÑ€Ð°Ð½Ñ‹Ðµ Ð¸ÐºÐ¾Ð½ÐºÐ¸ Ð¸ desktop"
          cp "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/org.fooyin.fooyin.png" "$INSTALL_PREFIX/usr/share/icons/hicolor/256x256/apps/org.fooyin.Fooyin.png"
          cp "$INSTALL_PREFIX/share/applications/org.fooyin.fooyin.desktop" "$INSTALL_PREFIX/usr/share/applications/org.fooyin.Fooyin.desktop"

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .desktop Ñ„Ð°Ð¹Ð» Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ printf
          #printf "[Desktop Entry]\nVersion=1.0\nType=Application\nName=Fooyin\nComment=A customisable music player\nExec=fooyin %%F\nIcon=fooyin\nTerminal=false\nCategories=AudioVideo;Player;\nMimeType=application/x-ogg;audio/aac;audio/mp4;audio/mpeg;audio/ogg;audio/x-flac;audio/x-m4a;audio/x-mp3;audio/x-mpeg;audio/x-ms-wma;audio/x-vorbis;audio/x-vorbis+ogg;audio/x-wav;\nStartupNotify=true\n" > "${{ env.INSTALL_PREFIX }}/share/applications/fooyin.desktop"
          
          echo " "
          echo "ls -la "$INSTALL_PREFIX/bin/""
          ls -la "$INSTALL_PREFIX/bin/"
          echo " "
          echo "ls -la "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/""
          ls -la "$INSTALL_PREFIX/share/icons/hicolor/256x256/apps/"
          echo " "
          echo "ls -la "$INSTALL_PREFIX/share/applications/""
          ls -la "$INSTALL_PREFIX/share/applications/"
          echo " "

      # --- ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Fooyin Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ ---
      - name: Set Version from REF
        id: set-version
        run: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ REF ÐºÐ°Ðº Ð²ÐµÑ€ÑÐ¸ÑŽ
          VERSION="${{ env.REF }}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Using REF as version: $VERSION"


      - name: Build AppImage
        run: |
          export VERSION=${{ env.VERSION }}
          appimage-builder --recipe recipe.yml --skip-test
          #appimage-builder --recipe recipe.yml --skip-test --build-arg VERSION=${{ env.VERSION }}
          

      - name: Check AppImage files
        run: |
          echo "ðŸ“¦ Generated AppImage files:"
          ls -la Fooyin-*.AppImage*
          echo "VERSION=${{ env.VERSION }}"

      - name: Upload AppImage Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fooyin-${{ env.VERSION }}-AppImage
          path: |
            Fooyin-*-x86_64.AppImage
            Fooyin-*-x86_64.AppImage.zsync

      - name: Create GitHub Release
        if: ${{ success() }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: fooyin-${{ env.VERSION }}-appimage
          name: "Fooyin ${{ env.VERSION }} (AppImage)"
          body: |
            Automatic AppImage build for Fooyin ${{ env.VERSION }}

            **Build Details:**
            - **Fooyin Version:** ${{ env.VERSION }}
            - **Qt Version:** ${{ env.QT_VERSION }} (Prebuilt)
            - **FFmpeg Version:** ${{ env.FFMPEG_VERSION }}
            - **Build Date:** $(date -u +"%Y-%m-%d")

            Built from ref: ${{ env.REF }}
          files: |
            Fooyin-*-x86_64.AppImage
            Fooyin-*-x86_64.AppImage.zsync
          prerelease: ${{ !contains(env.VERSION, 'v') && env.VERSION != 'master' }}
          draft: false
