name: –°–±–æ—Ä–∫–∞ Fooyin AppImage (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

on:
  schedule:
    - cron: '0 0 * * 0' # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 00:00 UTC
  push:
    branches:
      - main
    tags:
      - 'v*' # –¢–∞–∫–∂–µ —Å–æ–±–∏—Ä–∞—Ç—å –ø—Ä–∏ –Ω–æ–≤–æ–º —Ç–µ–≥–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, v1.2.3)

permissions:
  contents: write   # –Ω—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

jobs:
  build-appimage:
    runs-on: ubuntu-24.04
    steps:
      - name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      - name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          
          sudo apt-get update
          sudo apt-get install -y wget curl jq binutils tar file libfuse2 \
            libglib2.0-0 libnss3 libnspr4 libatk1.0-0 \
            libatk-bridge2.0-0 libcups2 libdrm2 libdbus-1-3 \
            libexpat1 libfontconfig1 libgbm1 libgl1 \
            libgtk-3-0 libpango-1.0-0 libx11-6 libxcb1 \
            libxcomposite1 libxdamage1 libxext6 libxfixes3 \
            libxrandr2 libxrender1 libasound2t64 libatspi2.0-0 \
            libqt6core6 libqt6gui6 libqt6widgets6 libqt6qml6 libqt6quick6 \
            libqt6multimedia6 libqt6opengl6

      - name: –°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π .deb –ø–∞–∫–µ—Ç Fooyin
        id: download-deb
        run: |
          echo "üîç –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–ª–∏–∑–∞ Fooyin..."
          LATEST_TAG=$(curl -s "https://api.github.com/repos/fooyin/fooyin/releases/latest" | jq -r '.tag_name')
          DEB_URL="https://github.com/fooyin/fooyin/releases/download/${LATEST_TAG}/fooyin_${LATEST_TAG#v}-plucky_amd64.deb"
          echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ: $DEB_URL"
          wget -O fooyin_latest.deb "$DEB_URL"
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "DEB_URL=$DEB_URL" >> $GITHUB_ENV
          echo "‚úÖ –£—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω–æ: $LATEST_TAG"

      - name: üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ .deb —Ñ–∞–π–ª–∞
        run: |
          echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ .deb —Ñ–∞–π–ª–∞..."
          # –ù–∞—Ö–æ–¥–∏–º —Å–∫–∞—á–∞–Ω–Ω—ã–π .deb
          DEB_FILE=$(ls *.deb | head -n 1)
          echo "–ù–∞–π–¥–µ–Ω –ø–∞–∫–µ—Ç: $DEB_FILE"

          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ deb (ar-–∞—Ä—Ö–∏–≤)
          ar x "$DEB_FILE"

          mkdir -p fooyin-appdir

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –∞—Ä—Ö–∏–≤ —Å –¥–∞–Ω–Ω—ã–º–∏ –≤–Ω—É—Ç—Ä–∏ (.xz, .zst, .gz, ...)
          DATA_TAR=$(ls data.tar.* | head -n 1)
          echo "–†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤: $DATA_TAR"

          tar -xf "$DATA_TAR" -C fooyin-appdir/

          # –£–±–∏—Ä–∞–µ–º –º—É—Å–æ—Ä
          rm -f "$DEB_FILE" control.tar.* debian-binary "$DATA_TAR"


      - name: –°–∫–∞—á–∞—Ç—å AppImageTool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share
          mkdir -p AppDir/usr/lib/x86_64-linux-gnu

      - name: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –∏–∑ .deb –≤ AppDir
        run: |
          cp -r fooyin-appdir/usr/* AppDir/usr/

      # -----------------------
      # 1. –ö–µ—à–∏—Ä—É–µ–º —É–∂–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
      - name: Cache FFmpeg libs
        id: cache-ffmpeg
        uses: actions/cache@v3
        with:
          path: ~/ffmpeg_build
          key: ffmpeg-6.0-${{ runner.os }}

      # -----------------------
      # 2. –°–±–æ—Ä–∫–∞ libavcodec61/libavformat61, –µ—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç–æ–π
      - name: Build libavcodec61/libavformat61
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y autoconf automake build-essential cmake git libtool \
          pkg-config texinfo yasm nasm zlib1g-dev libx264-dev libx265-dev \
          libvpx-dev libfdk-aac-dev libmp3lame-dev libopus-dev wget

          mkdir -p ~/ffmpeg_build && cd ~/ffmpeg_build
          wget https://ffmpeg.org/releases/ffmpeg-6.0.tar.bz2
          tar xjf ffmpeg-6.0.tar.bz2
          cd ffmpeg-6.0
          ./configure --prefix=$HOME/ffmpeg_build --disable-programs --disable-doc --enable-shared
          make -j$(nproc)
          make install

      # -----------------------
      # 3. –ö–æ–ø–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –≤ AppDir
      - name: Copy FFmpeg libs to AppDir
        run: |
          mkdir -p AppDir/usr/lib
          cp $HOME/ffmpeg_build/lib/libavcodec.so* AppDir/usr/lib/
          cp $HOME/ffmpeg_build/lib/libavformat.so* AppDir/usr/lib/
          cp -r $HOME/ffmpeg_build/include AppDir/usr/

      # -----------------------
      # 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º LD_LIBRARY_PATH –≤ AppRun
      - name: Set library path
        run: |
          echo 'export LD_LIBRARY_PATH=$APPDIR/usr/lib:$LD_LIBRARY_PATH' >> AppDir/AppRun

      # -----------------------

      - name: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫
        run: |
          copy_deps() {
            local binary="$1"
            if [ ! -f "$binary" ]; then
              echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $binary"
              exit 1
            fi
            echo "üîç –ü–æ–∏—Å–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è: $binary"
            ldd "$binary" | awk '/=>/ { print $3 }' | while read lib; do
              if [ -n "$lib" ] && [ -f "$lib" ]; then
                mkdir -p "AppDir$(dirname "$lib")"
                cp "$lib" "AppDir$lib"
                echo "   ‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: $lib"
              fi
            done
          }
          copy_deps "AppDir/usr/bin/fooyin"

      - name: –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç AppRun
        run: |
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/x86_64-linux-gnu:${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export QT_PLUGIN_PATH="${HERE}/usr/lib/x86_64-linux-gnu/qt6/plugins"
          export QML2_IMPORT_PATH="${HERE}/usr/lib/x86_64-linux-gnu/qt6/qml"
          export PATH="${HERE}/usr/bin:${PATH}"
          exec "${HERE}/usr/bin/fooyin" "$@"
          EOF
          chmod +x AppDir/AppRun

      - name: –°–æ–∑–¥–∞—Ç—å .desktop —Ñ–∞–π–ª
        run: |
          cat > AppDir/fooyin.desktop << 'EOF'
          [Desktop Entry]
          Name=Fooyin
          Comment=–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø—Ä–æ–∏–≥—Ä—ã–≤–∞—Ç–µ–ª—å –º—É–∑—ã–∫–∏ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –≤—ã—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ
          Exec=fooyin
          Icon=fooyin
          Terminal=false
          Type=Application
          Categories=AudioVideo;Audio;
          MimeType=audio/mpeg;audio/x-flac;audio/wav;audio/x-wav;audio/ogg;audio/x-ogg;audio/aac;audio/x-m4a;audio/flac;audio/mp4;
          EOF

      - name: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É
        run: |
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          ICON_FILE=$(find AppDir/usr/share/icons -name "*fooyin*" -o -name "*Fooyin*" -type f | head -1)
          if [ -n "$ICON_FILE" ]; then
            cp "$ICON_FILE" AppDir/usr/share/icons/hicolor/256x256/apps/fooyin.png
            cp "$ICON_FILE" AppDir/fooyin.png
            echo "‚úÖ –ò–∫–æ–Ω–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞: $ICON_FILE"
          else
            echo "‚ö†Ô∏è –ò–∫–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–∞–∫–µ—Ç–µ. –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å fallback..."
            wget -O AppDir/fooyin.png https://raw.githubusercontent.com/fooyin/fooyin/master/resources/fooyin-icon.png 2>/dev/null && echo "‚úÖ Fallback –∏–∫–æ–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞" || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É"
          fi

      - name: –°–æ–±—Ä–∞—Ç—å AppImage
        run: |
          ./appimagetool-x86_64.AppImage AppDir Fooyin-${{ env.LATEST_TAG }}-x86_64.AppImage

      - name: –ó–∞–≥—Ä—É–∑–∏—Ç—å AppImage –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
        uses: actions/upload-artifact@v4
        with:
          name: Fooyin-AppImage
          path: Fooyin-*.AppImage

      - name: –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
        id: get-date
        run: |
          echo "BUILD_DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_ENV

      - name: –°–æ–∑–¥–∞—Ç—å GitHub Release (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ç–µ–≥–∞—Ö)
        #if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: Fooyin-*.AppImage
          tag_name: ${{ env.LATEST_TAG }}
          name: Fooyin ${{ env.LATEST_TAG }}
          body: |
            Fooyin AppImage —Å–æ–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ .deb –ø–∞–∫–µ—Ç–∞.

            **–í–µ—Ä—Å–∏—è:** ${{ env.LATEST_TAG }}
            **–î–∞—Ç–∞ —Å–±–æ—Ä–∫–∏:** ${{ env.BUILD_DATE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
